<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Online TV - v0.4.roc1100303</title>
		<!-- The preset settings, such as channel-number pairs. --> <script src="presetSettings.js"></script>
		<script>/*Control*/
			player = {}; // Global Variable.
			playerStructure = { /*the structure of the player*/
				yt: (type, ID, whetherToLoop, whetherAutoGetUpToDate)=>{
					if(typeof(ytPlayer) != "undefined"){
						ytPlayer.destroy();
					}
					console.log("debug! %d", (whetherToLoop)?1:0);

					let playerVars = {
						controls: 0,
						disablekb: 1, /* disablekb is to remove all the keyboard shortcuts (especially NUMBER). Add back or change some of them later. */
						iv_load_policy:3,
						rel: 0,
						fs: 0,
					}
					if(type=="List"){
						playerVars.listType = "playlist";
						playerVars.list = ID;
					}
					if(whetherToLoop == true){
						playerVars.loop= "1";
						if(type=="Video"){
							playerVars.playlist = ID;
						}
					}

					ytPlayer = new YT.Player("ytPlayer", {
						height: "100%",
						width: "100%",
						videoId: (type=="Stream" || type=="Video")?ID:"",
						playerVars: playerVars,
						events:{
							"onReady": (event)=>{
								/*autoplay & try to get up-to-date*/
								ytPlayer.playVideo();
								ytPlayer.toggledEventID = []; /**/
							},
							"onStateChange": (whetherAutoGetUpToDate)?(event)=>{
								var state = event.data;
								if(
									state == -1 /*unstarted*/ ||
									state == YT.PlayerState.PAUSED ||
									state == YT.PlayerState.CUED
								){
									/*Here we use a weird way to detect if an event has been triggered or not. If true, than ignore it. We couldn't use ytPlayer.removeEventListener("onStateChange", a) because this part of the api seems to be broken.*/
									var ID = Date.now();
									var a = (event) => {
										if(ytPlayer.toggledEventID.includes(ID)){
											return;
										}

										var state = event.data;
										if(
											state == YT.PlayerState.PLAYING ||
											state == YT.PlayerState.BUFFERING
										){
											ytPlayer.getUpToDate();
										}
										ytPlayer.toggledEventID.push(ID);
										return;
									};
									ytPlayer.addEventListener("onStateChange", a);
									return;
								}
							}:(event)=>{}
						}
					});/*video control shortcuts*/
					ytPlayer.playAndPause = ()=>{
						if(ytPlayer.getPlayerState() == YT.PlayerState.PAUSED){
							ytPlayer.playVideo();
						}else{
							ytPlayer.pauseVideo();
						}
					};
					ytPlayer.getUpToDate = () => {
						ytPlayer.setPlaybackRate(2);/*Once it gets to the newest, the video would pause for seconds and auto-set the speed to 1*/
						notifi = createNotifi("adjusting", "正在縮短時間差，請稍待……");
					}
					window.addEventListener('keydown', (event)=>{
						switch(event.key){
							/*Volume Up*/
							case "+":
							case "ArrowRight":
								var vol = ytPlayer.getVolume();
								ytPlayer.setVolume(vol + 5);
								createNotifi(
									"volume",
									"Vol:" + ((vol<=95)?(vol + 5):(100)) + "%",
									5, {
										display: "inline",
										position: "fixed",
										top: "2.5vh",
										left: "2.5vh",
								});
								break;

							/*Volume Down*/
							case "-":
							case "ArrowLeft":
								var vol = ytPlayer.getVolume();
								ytPlayer.setVolume(vol + 5);
								ytPlayer.setVolume(vol - 5);
								createNotifi(
									"volume",
									"Vol:" + ((vol>=5)?(vol - 5):(0)) + "%",
									5, {
										display: "inline",
										position: "fixed",
										top: "2.5vh",
										left: "2.5vh",
								});
								break;

							/*Pause & Play*/
							case " ":
								ytPlayer.playAndPause();
								break;

							/*FullScreen*/
							case "f":
								fullscreen("switch");

							/*Clean the notification*/
							case "Escape":
								cleanAllNotifi();
						}
					});
					return ytPlayer;
				}
			};

			function fullscreen(newState){
				if(newState !== "undefined"){
					if(newState == true || newState == "on"){ //turn on fullscreen
						document.documentElement.requestFullscreen();
					}else if(newState == false || newState == "off"){ //turn off fullscreen
						document.exitFullscreen();
					}if(newState == "switch"){ //switch fullscreen
						if(!document.fullscreenElement){
							document.documentElement.requestFullscreen();
						}else{
							document.exitFullscreen();
						}
					}
				}
				return (!document.fullscreenElement)?false:true; //return fullscreen state
			}

			function switchChannel(number){
				channel = presetChannelList[number]; //get info of the channel
				if(typeof(channel)=="undefined"){
					console.log("ERR: The required channel doesn't exist.");
					return -1;
				}
				if(channel.server = "yt"){
					let loop = false, ytAutoUpToDate = false;
					if(channel.ytType == "List" || channel.ytType == "Video"){
						loop = true;
					}else if(channel.ytType == "Stream"){
						ytAutoUpToDate = true;
					}else{
						console.log("ERR: \"ytType\" should be one of [\"List\", \"Video\", \"Stream\"], instead of \"%s\".", channel.ytType);
						return -1;
					}
					ytPlayer = playerStructure.yt(channel.ytType, channel.ytCode, loop, ytAutoUpToDate);
					console.log("O K: NewChannel!");
 					return 0;
				}
				console.log("ERR: \"server\" should be one of [\"yt\"(, \"m3u8\")], instead of \"%s\".", channel.server);
				return -1;
			}

			var newChannelNumber = ""; /*the number of video*/
			window.addEventListener("keydown", (event)=>{/*switch channel*/
				whetherChangedNumberString = true;
				if(
					!event.ctrlKey &&
					!event.altKey &&
					!event.shiftKey &&
					!event.metaKey &&  ["0","1","2","3","4","5","6","7","8","9"].includes(event.key)
				){/*type in number*/
					newChannelNumber += event.key;
				}else{/*remove number at the end*/
					switch(event.key){
						case "Delete":
							newChannelNumber = "";
							break;
						case "Backspace":
							newChannelNumber = newChannelNumber.slice(0, newChannelNumber.length-1);
							break;
						case "Enter":
							whetherChangedNumberString = false;
							cleanAllNotifi();
							if(switchChannel(newChannelNumber)==0 /*Success*/){
								createNotifi(
									"newChannelNumber",
									"OK",
									3, {
										display: "inline",
										position: "fixed",
										top: "2.5vh",
										right: "2.5vh",
										"background-color": "rgba(0,255,0,0.5)"
								});
							}else{/* -1, failed*/
								createNotifi(
									"newChannelNumber",
									"Not Exists",
									3, {
										display: "inline",
										position: "fixed",
										top: "2.5vh",
										right: "2.5vh",
										"background-color": "rgba(255,0,0,0.5)"
								});
							}
							newChannelNumber = "";
							break;
						default:
							whetherChangedNumberString = false;
					}
				}
				/*show the number on the screen*/
				if(whetherChangedNumberString == true){
					createNotifi(
						"newChannelNumber",
						newChannelNumber,
						5, {
							display: "inline",
							position: "fixed",
							top: "2.5vh",
							right: "2.5vh"
					});
				}
			});



		</script>
		<script>/*Notification Manger*/
			notiList = [];
			function createNotifi(id, msg, lastingSecond, styleList){
				if(typeof(id)!="undefined" && id!='' && id!=null && id != "@TEMP" && typeof(notiList[id]) != "undefined"){
					notiList[id].remove();
				}

				if( typeof(msg)!="undefined" && msg!='' && msg!=null){
					notifiHolder = document.querySelector("#notifiHolder");
					presetStyleList = {
						"background": "rgba(0,0,0,.5)",
						"color": "white",
						"border-radius": "10px",
						"padding": "10px",
						"font-size": "36px",
						"margin": "10px"
					};
					var noti = document.createElement("div");

					noti.innerHTML = msg;
					for(var key in presetStyleList){
						noti.style[key] = presetStyleList[key];
					}
					for(var key in styleList){
						noti.style[key] = styleList[key];
					}
					notifiHolder.appendChild(noti);

					if(typeof lastingSecond == "number" && lastingSecond > 0 ){
						window.setTimeout(()=>{noti.remove()}, lastingSecond * 1000);
					}else if(typeof lastingSecond == "string" && ["infinity", "unlimited", "unrestricted", "forever"].includes(lastingSecond)){x
						// do nothing
					}else{
						window.setTimeout(()=>{noti.remove()}, 10000);
					}

					notiList[id] = noti;
					return noti;
				}else{
					return "notiRemoved";
				}

			}
			function cleanAllNotifi(){
				notifiHolder = document.querySelector("#notifiHolder");
				notifiHolder.innerHTML = null;
			}
		</script>
	</head>
	<body style="margin:0; padding: 0; box-sizing: border-box;">
		<script>document.body.addEventListener("blur", ()=>{console.log("blur!");document.body.focus();});
			setTimeout(()=>{document.body.focus();}, 50);
		</script>
		<div id="playerHolder" style="width: 100vw; height: 100vh; line-height:0;">
			<div id="ytPlayer"></div>
			<script>/*Load & auto-play youtube video*/
				// Load the IFrame Player API code asynchronously.
				var tag = document.createElement('script');
				tag.src = "https://www.youtube.com/player_api";
				var firstScriptTag = document.getElementsByTagName('script')[0];
				firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

				// Replace #ytPlayer element with an <iframe> and
				// YouTube ytPlayer after the API code downloads.
				var ytPlayer;
				function onYouTubePlayerAPIReady(){
					ytPlayer = playerStructure.yt("Stream", "5tQBwbyQ-Fw", true, true);
				}

			</script>
		</div>
		<div id="playerCover" style="width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; padding: 0; margin: 0; opacity: 0">
			<script>
				var playerCover = document.querySelector("#playerCover");
				var playerCoverClicked = (
					()=>{
						var counter = 0;
						var date = new Date;
						var timeout;
						return (event)=>{
							clearTimeout(timeout);
							counter += 1;
							if(counter == 1){
								timeout = setTimeout(()=>{/*play or pause video*/
									ytPlayer.playAndPause();
									counter = 0;
								}, 250);
							}else if(counter >= 2){/*fullscreen*/
								fullscreen("switch");
								counter=0;
							}
						}
					}
				)();
				playerCover.addEventListener("click", playerCoverClicked);
			</script>
		</div>
		<div id="notifiHolder" style="width: 100vw; position: absolute; height:0; top: 10vh; left: 0; padding: 0; margin: 0; text-align: center; pointer-events: none">
		</div>

	</body>
</html>
